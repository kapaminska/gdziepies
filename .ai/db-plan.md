````markdown
## 1. Lista tabel z ich kolumnami, typami danych i ograniczeniami

### Typy niestandardowe (ENUM)
W celu zapewnienia integralności i wydajności danych definiuje się następujące typy ENUM.

```sql
CREATE TYPE announcement_type AS ENUM ('lost', 'found');
CREATE TYPE announcement_status AS ENUM ('active', 'resolved');
CREATE TYPE animal_species AS ENUM ('dog', 'cat');
CREATE TYPE animal_size AS ENUM ('small', 'medium', 'large');
CREATE TYPE animal_age_range AS ENUM ('young', 'adult', 'senior');
````

### Tabela `profiles`

Przechowuje publiczne dane użytkowników, powiązane z wbudowaną tabelą `auth.users` Supabase.

```sql
CREATE TABLE profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  username TEXT NOT NULL UNIQUE,
  phone_number TEXT, -- Dane kontaktowe chronione przez RPC
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ
);
```

### Tabela `announcements`

Główna tabela przechowująca wszystkie ogłoszenia o zaginionych lub znalezionych zwierzętach.

```sql
CREATE TABLE announcements (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  author_id uuid NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  
  -- Statusy i typy
  type announcement_type NOT NULL,
  status announcement_status NOT NULL DEFAULT 'active',
  
  -- Lokalizacja i data
  voivodeship TEXT NOT NULL,
  poviat TEXT NOT NULL,
  location_details TEXT, -- Opcjonalne (np. ulica, park)
  event_date DATE NOT NULL,
  
  -- Informacje o zwierzęciu (wymagane)
  species animal_species NOT NULL,
  image_url TEXT NOT NULL, -- Link do Supabase Storage
  
  -- Informacje o zwierzęciu (opcjonalne)
  size animal_size,
  color TEXT,
  age_range animal_age_range,
  description TEXT,
  special_marks TEXT,
  
  -- Temperament (checkboxy)
  is_aggressive BOOLEAN NOT NULL DEFAULT false,
  is_fearful BOOLEAN NOT NULL DEFAULT false,
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ
);
```

### Tabela `comments`

Przechowuje komentarze użytkowników powiązane z ogłoszeniami.

```sql
CREATE TABLE comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  announcement_id uuid NOT NULL REFERENCES announcements(id) ON DELETE CASCADE,
  author_id uuid NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  
  -- Flaga dla US-009
  is_sighting BOOLEAN NOT NULL DEFAULT false,
  
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### Tabela `reports`

Loguje zgłoszenia nadużyć dotyczące ogłoszeń (US-012).

```sql
CREATE TABLE reports (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  announcement_id uuid NOT NULL REFERENCES announcements(id) ON DELETE CASCADE,
  reporting_user_id uuid NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  reason TEXT, -- Opcjonalny powód zgłoszenia
  created_at TIMESTAMPTZ DEFAULT now(),
  
  -- Użytkownik może zgłosić dane ogłoszenie tylko raz
  UNIQUE(announcement_id, reporting_user_id)
);
```

## 2\. Relacje między tabelami

  * **`auth.users` (1) --- (1) `profiles`**: Relacja jeden-do-jednego. Klucz `profiles.id` jest kluczem obcym wskazującym na `auth.users.id`.
  * **`profiles` (1) --- (N) `announcements`**: Relacja jeden-do-wielu. Jeden użytkownik (profil) może mieć wiele ogłoszeń. (`announcements.author_id` -\> `profiles.id`).
  * **`profiles` (1) --- (N) `comments`**: Relacja jeden-do-wielu. Jeden użytkownik (profil) może napisać wiele komentarzy. (`comments.author_id` -\> `profiles.id`).
  * **`profiles` (1) --- (N) `reports`**: Relacja jeden-do-wielu. Jeden użytkownik (profil) może zgłosić wiele ogłoszeń. (`reports.reporting_user_id` -\> `profiles.id`).
  * **`announcements` (1) --- (N) `comments`**: Relacja jeden-do-wielu. Jedno ogłoszenie może mieć wiele komentarzy. (`comments.announcement_id` -\> `announcements.id`).
  * **`announcements` (1) --- (N) `reports`**: Relacja jeden-do-wielu. Jedno ogłoszenie może być wielokrotnie zgłaszane (przez różnych użytkowników). (`reports.announcement_id` -\> `announcements.id`).

## 3\. Indeksy

Indeksy są kluczowe dla wydajności filtrowania (US-004) oraz operacji JOIN.

### Indeksy na `announcements` (dla filtrowania)

```sql
-- Indeks złożony dla filtrowania lokalizacji
CREATE INDEX idx_announcements_location ON announcements (voivodeship, poviat);

-- Indeksy dla kluczowych filtrów
CREATE INDEX idx_announcements_species ON announcements (species);
CREATE INDEX idx_announcements_status ON announcements (status);
CREATE INDEX idx_announcements_size ON announcements (size);
CREATE INDEX idx_announcements_age_range ON announcements (age_range);
CREATE INDEX idx_announcements_color ON announcements (color);
CREATE INDEX idx_announcements_event_date ON announcements (event_date);
```

### Indeksy na kluczach obcych (dla wydajności JOIN)

```sql
CREATE INDEX idx_announcements_author_id ON announcements (author_id);
CREATE INDEX idx_comments_announcement_id ON comments (announcement_id);
CREATE INDEX idx_comments_author_id ON comments (author_id);
CREATE INDEX idx_reports_announcement_id ON reports (announcement_id);
CREATE INDEX idx_reports_reporting_user_id ON reports (reporting_user_id);
```

## 4\. Zasady PostgreSQL (Row Level Security - RLS)

RLS jest fundamentem bezpieczeństwa aplikacji, chroniącym dane użytkowników.

### Tabela `profiles`

  * Polityka: Użytkownicy mogą aktualizować i usuwać własny profil. Odczyt jest publiczny (aby pobrać `username` do komentarzy). Dostęp do `phone_number` jest zarządzany przez RPC.

<!-- end list -->

```sql
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read" 
  ON profiles FOR SELECT USING (true);

CREATE POLICY "Allow self update" 
  ON profiles FOR UPDATE USING (auth.uid() = id);
  
CREATE POLICY "Allow self delete" 
  ON profiles FOR DELETE USING (auth.uid() = id);
```

*Uwaga: Wstawianie nowych profili (INSERT) powinno być obsługiwane przez trigger na tabeli `auth.users`.*

### Tabela `announcements`

  * Polityka: Odczyt jest publiczny. Tylko zalogowani użytkownicy mogą tworzyć ogłoszenia. Tylko autorzy mogą modyfikować lub usuwać swoje ogłoszenia.

<!-- end list -->

```sql
ALTER TABLE announcements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read" 
  ON announcements FOR SELECT USING (true);

CREATE POLICY "Allow authenticated insert" 
  ON announcements FOR INSERT WITH CHECK (auth.role() = 'authenticated');
  
CREATE POLICY "Allow self update" 
  ON announcements FOR UPDATE USING (auth.uid() = author_id) WITH CHECK (auth.uid() = author_id);
  
CREATE POLICY "Allow self delete" 
  ON announcements FOR DELETE USING (auth.uid() = author_id);
```

### Tabela `comments`

  * Polityka: Odczyt jest publiczny. Tylko zalogowani użytkownicy mogą komentować. Użytkownicy mogą edytować i usuwać własne komentarze (założenie na podstawie nierozstrzygniętej kwestii nr 2).

<!-- end list -->

```sql
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read" 
  ON comments FOR SELECT USING (true);
  
CREATE POLICY "Allow authenticated insert" 
  ON comments FOR INSERT WITH CHECK (auth.role() = 'authenticated');
  
CREATE POLICY "Allow self update" 
  ON comments FOR UPDATE USING (auth.uid() = author_id) WITH CHECK (auth.uid() = author_id);
  
CREATE POLICY "Allow self delete" 
  ON comments FOR DELETE USING (auth.uid() = author_id);
```

### Tabela `reports`

  * Polityka: Zgłoszenia nie są publicznie odczytywalne. Tylko zalogowani użytkownicy mogą tworzyć zgłoszenia we własnym imieniu.

<!-- end list -->

```sql
ALTER TABLE reports ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Block public read" 
  ON reports FOR SELECT USING (false); -- Tylko admin (np. service_role) może czytać

CREATE POLICY "Allow authenticated insert" 
  ON reports FOR INSERT WITH CHECK (auth.role() = 'authenticated' AND auth.uid() = reporting_user_id);
```

## 5\. Wszelkie dodatkowe uwagi lub wyjaśnienia dotyczące decyzji projektowych

1.  **Trigger dla `profiles`**: Niezbędne jest utworzenie funkcji i triggera w PostgreSQL, który automatycznie utworzy nowy wiersz w tabeli `profiles` (kopiując `id` i ewentualnie pobierając dane z `raw_user_meta_data`) za każdym razem, gdy nowy użytkownik zostanie zarejestrowany w tabeli `auth.users`.
2.  **Ochrona danych kontaktowych (RPC)**: Zgodnie z decyzjami (Decyzja 5) oraz PRD (US-010), dane wrażliwe (jak `phone_number` w tabeli `profiles`) nie powinny być pobierane domyślnie. Tabela `profiles` ma publiczny odczyt RLS (dla `username`), dlatego zaleca się stworzenie funkcji PostgreSQL (RPC) w Supabase, np. `get_contact_details(p_announcement_id uuid)`, która:
      * Sprawdza, czy bieżący użytkownik jest uwierzytelniony (`auth.role() = 'authenticated'`).
      * Jeśli tak, zwraca `phone_number` autora ogłoszenia o podanym `p_announcement_id`.
      * Ta funkcja powinna być wywoływana po stronie klienta tylko "na żądanie" (np. po kliknięciu przycisku "Pokaż kontakt").
3.  **Zarządzanie lokalizacją**: Zgodnie z Decyzją 4, dane `voivodeship` i `poviat` są przechowywane jako `TEXT`. Oznacza to, że walidacja i spójność tych danych (np. pobieranie z zewnętrznej biblioteki lub API) muszą być zapewnione po stronie aplikacji (frontend lub backend API), zanim dane zostaną zapisane w bazie.
4.  **Supabase Storage**: Kolumna `image_url` zakłada wykorzystanie Supabase Storage. Należy skonfigurować odpowiednie polityki RLS dla bucketa przechowującego zdjęcia, aby umożliwić publiczny odczyt (`SELECT`) oraz autoryzowane przesyłanie (`INSERT`/`UPDATE`) powiązane z `author_id` ogłoszenia.
5.  **Edycja/Usuwanie Komentarzy**: PRD nie precyzował tej kwestii (Nierozstrzygnięta kwestia nr 2). Powyższy schemat RLS zakłada, że użytkownicy *mogą* edytować i usuwać własne komentarze. Jeśli wymaganie jest inne, polityki RLS dla `comments` (UPDATE/DELETE) powinny zostać zmodyfikowane.

<!-- end list -->

```
```