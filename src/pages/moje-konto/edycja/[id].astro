---
import Layout from '../../../layouts/Layout.astro';
import { AdForm } from '../../../components/announcements/AdForm';
import { AnnouncementService } from '../../../lib/services/announcement.service';
import { NotFoundError } from '../../../lib/errors';

// Verify authentication
const {
  data: { user },
  error: authError,
} = await Astro.locals.supabase.auth.getUser();

if (authError || !user) {
  return Astro.redirect('/logowanie');
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/moje-konto');
}

// Get announcement data
let announcement;
try {
  announcement = await AnnouncementService.getAnnouncementById(
    id,
    Astro.locals.supabase
  );
} catch (error) {
  if (error instanceof NotFoundError) {
    return Astro.redirect('/moje-konto');
  }
  throw error;
}

// Verify ownership
if (announcement.author_id !== user.id) {
  return Astro.redirect('/moje-konto');
}

const userId = user.id;
---

<Layout title="Edytuj ogÅ‚oszenie">
  <main class="container mx-auto px-4 py-8">
    <AdForm
      client:only="react"
      mode="edit"
      initialData={announcement}
      userId={userId}
    />
  </main>
</Layout>

